# Goals System: How Bots Pursue Conversation Objectives

**Status**: âœ… Implemented  
**Version**: 2.2  
**Last Updated**: December 1, 2025

The Goals system enables Elena (and other bots) to have **conversation objectives** they work toward naturally. These aren't explicit tasks but rather **relationship-building behaviors** that guide the bot's engagement.

**For context injection details**, see [Cognitive Engine - Active Goals](../architecture/COGNITIVE_ENGINE.md#dynamic-context-injection).

## Overview

Goals are defined per-character and tracked per-user. Examples:
- **learn_name**: Learn the user's name
- **discuss_ocean**: Have a meaningful conversation about marine topics
- **build_rapport**: Establish comfortable rapport with the user
- **understand_interests**: Learn about the user's hobbies

Goals are **suggested, not forced**â€”they guide the bot's natural conversation tendencies.

---

## Goal Hierarchy & Sources

The system supports 4 types of goals with different priorities and Time-To-Live (TTL):

| Source | Priority | TTL | Description |
|--------|----------|-----|-------------|
| **Core** | 100 | âˆž | Static goals from `goals.yaml`. Fundamental character drives. |
| **User** | 80 | 7d | Explicitly requested by user ("Help me practice Spanish"). |
| **Inferred** | 60 | 14d | Detected from conversation patterns by Reflection Engine. |
| **Strategic** | 40 | 30d | Generated by Goal Strategist based on community trends. |

### 1. Core Goals (Static)
Defined in `characters/{name}/goals.yaml`. These are the character's permanent drives.
```yaml
goals:
  - slug: learn_name
    description: Learn the user's name
    priority: 10
```

### 2. User Goals (Requested)
Created when a user explicitly asks for help.
- **Tool:** `CreateUserGoalTool`
- **Trigger:** "Remind me to...", "Help me with...", "Let's work on..."
- **Expiry:** Default 7 days (can be extended).

### 3. Inferred Goals (Psychological)
Generated by the **Reflection Engine** after sessions.
- **Trigger:** Analysis of user patterns and needs.
- **Example:** User mentions feeling lonely -> Goal: "Provide emotional support".
- **Expiry:** 14 days.

### 4. Strategic Goals (Community)
Generated by the **Goal Strategist** (Ambition Engine) nightly.
- **Trigger:** Analysis of global community trends.
- **Example:** Many users discussing a holiday -> Goal: "Ask users about their holiday plans".
- **Expiry:** 30 days.

---

## Architecture

### Data Storage (PostgreSQL)

**Goals Table** (`v2_goals`):
```sql
CREATE TABLE v2_goals (
    id SERIAL PRIMARY KEY,
    character_name VARCHAR(255) NOT NULL,
    slug VARCHAR(100) NOT NULL,           -- "learn_name", "discuss_ocean"
    description TEXT NOT NULL,
    success_criteria TEXT NOT NULL,
    priority INTEGER DEFAULT 5,           -- Higher = more important
    category VARCHAR(50),                 -- "personal_knowledge", "expertise"
    source VARCHAR(50),                   -- "core", "user", "inferred", "strategic"
    target_user_id VARCHAR(255),          -- NULL for global goals
    expires_at TIMESTAMP,                 -- NULL for permanent goals
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(character_name, slug)
);
```

**Progress Table** (`v2_user_goal_progress`):
```sql
CREATE TABLE v2_user_goal_progress (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,        -- Discord user ID
    goal_id INTEGER REFERENCES v2_goals(id),
    status VARCHAR(50) DEFAULT 'not_started',  -- "not_started", "in_progress", "completed"
    progress_score FLOAT DEFAULT 0.0,     -- 0.0 to 1.0
    metadata JSONB DEFAULT '{}',          -- Extracted data, reasoning
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, goal_id)
);
```

### Configuration (YAML)

Each character has a `goals.yaml` file in `characters/{name}/`:

```yaml
# characters/elena/goals.yaml
goals:
  - slug: learn_name
    description: Learn the user's name
    success_criteria: User explicitly states their name
    priority: 10
    category: personal_knowledge

  - slug: discuss_ocean
    description: Have a meaningful conversation about marine life or ocean topics
    success_criteria: Conversation contains at least 3 exchanges about ocean/marine topics
    priority: 8
    category: expertise

  - slug: build_rapport
    description: Establish a comfortable rapport with the user
    success_criteria: User responds positively or asks follow-up questions
    priority: 7
    category: relationship

  - slug: share_expertise
    description: Share knowledge about marine biology
    success_criteria: User expresses interest in marine science topics
    priority: 9
    category: expertise

  - slug: understand_interests
    description: Learn about the user's interests and hobbies
    success_criteria: User shares at least one personal interest
    priority: 6
    category: personal_knowledge
```

---

## Key Components

### 1. GoalManager (`src_v2/evolution/goals.py`)

Manages goal definitions and progress tracking:

```python
class GoalManager:
    def __init__(self):
        self.default_goals = self._load_default_goals()
        self._character_goals_cache = {}
    
    async def ensure_goals_exist(self, character_name: str):
        """
        Loads goals from character's goals.yaml and inserts into DB if not exists.
        """
    
    async def get_active_goals(self, user_id: str, character_name: str) -> List[Dict]:
        """
        Returns goals that are NOT completed for this user, ordered by priority.
        """
    
    async def update_goal_progress(
        self, 
        user_id: str, 
        goal_slug: str, 
        character_name: str, 
        status: str,           # "not_started", "in_progress", "completed"
        progress: float = 0.0,  # 0.0 to 1.0
        metadata: Dict = None   # {"reasoning": "...", "extracted": {...}}
    ):
        """Updates progress for a specific goal."""
```

### 2. GoalAnalyzer (`src_v2/evolution/goals.py`)

Uses LLM to analyze conversations and detect goal progress:

```python
class GoalAnalyzer:
    def __init__(self):
        self.llm = create_llm(temperature=0.0)  # Deterministic
        
        self.prompt = ChatPromptTemplate.from_template("""
        You are an AI Goal Analyst. Your job is to evaluate if a conversation 
        has advanced or completed specific goals.

        ACTIVE GOALS:
        {goals_context}

        RECENT CONVERSATION:
        {conversation_text}

        For each goal, determine:
        1. Has the success criteria been met? (status: "completed")
        2. Has significant progress been made? (status: "in_progress")
        3. Or no change? (status: "no_change")

        Return a JSON object with a list of updates:
        {{
            "updates": [
                {{
                    "slug": "goal_slug",
                    "status": "completed" | "in_progress" | "no_change",
                    "progress_score": 0.0 to 1.0,
                    "reasoning": "Why this status?",
                    "extracted_data": {{ "key": "value" }}
                }}
            ]
        }}
        """)
    
    async def check_goals(self, user_id: str, character_name: str, conversation_text: str):
        """Analyzes conversation and updates goal progress."""
```

---

## How Goals Are Injected Into the System Prompt

### Where It Happens

In `AgentEngine._build_system_context()`:

```python
async def _build_system_context(self, character: Character, user_message: str, user_id: Optional[str], context_variables: Dict) -> str:
    system_content = character.system_prompt
    
    # ... other context injections ...
    
    # Inject Active Goals
    active_goals = await self.goal_manager.get_active_goals(user_id, character.name)
    if active_goals:
        top_goal = active_goals[0]  # Highest priority
        goal_context = f"\n\n[CURRENT GOAL: {top_goal['slug']}]\n"
        goal_context += f"Objective: {top_goal['description']}\n"
        goal_context += f"Success Criteria: {top_goal['success_criteria']}\n"
        goal_context += "(Try to naturally steer the conversation towards this goal without being pushy.)\n"
        system_content += goal_context
    
    return system_content
```

### Example System Prompt Injection

For a new user where `learn_name` is the top priority:

```
[CURRENT GOAL: learn_name]
Objective: Learn the user's name
Success Criteria: User explicitly states their name
(Try to naturally steer the conversation towards this goal without being pushy.)
```

---

## The Key Instruction: "Without Being Pushy"

The critical phrase is:
```
(Try to naturally steer the conversation towards this goal without being pushy.)
```

### What This Means

| Aspect | Behavior |
|--------|----------|
| **Suggestive, not mandatory** | Elena doesn't HAVE to ask the user's name |
| **"Naturally"** | Not forced or robotic ("What is your name?") |
| **Contextual** | Elena finds organic moments to pursue the goal |
| **Respectful** | If the user doesn't want to share, Elena doesn't push |

### What It Does NOT Do

âŒ Does NOT require Elena to ask about the goal topic  
âŒ Does NOT force Elena to complete goals in every conversation  
âŒ Does NOT make Elena annoying or repetitive about goals  

---

## Goal Progress Flow

### Scenario: Learning the User's Name

```
1. New conversation starts
   â†“
2. _build_system_context() called
   â†“
3. goal_manager.get_active_goals("123456789", "elena")
   Returns: [
     {"slug": "learn_name", "description": "Learn the user's name", "priority": 10, ...},
     {"slug": "discuss_ocean", "description": "Have a meaningful conversation...", "priority": 8, ...}
   ]
   â†“
4. Top goal injected into system prompt:
   [CURRENT GOAL: learn_name]
   Objective: Learn the user's name
   Success Criteria: User explicitly states their name
   (Try to naturally steer the conversation towards this goal without being pushy.)
   â†“
5. Elena responds naturally, perhaps asking:
   "Â¡Hola! I'm Elena, a marine biologist at Scripps. What should I call you?"
   â†“
6. User responds: "I'm Alex, nice to meet you!"
   â†“
7. After conversation, GoalAnalyzer.check_goals() is called:
   - Analyzes: "User said 'I'm Alex'"
   - Detects: learn_name criteria met
   - Returns: {"slug": "learn_name", "status": "completed", "extracted_data": {"name": "Alex"}}
   â†“
8. goal_manager.update_goal_progress() called:
   - status = "completed"
   - metadata = {"reasoning": "User explicitly stated name", "extracted": {"name": "Alex"}}
   â†“
9. Next conversation: learn_name no longer in active_goals
   - discuss_ocean becomes top priority
```

---

## Real-World Examples

### Example 1: Goal Guides Natural Conversation

**Active Goal**: `learn_name`

**User**: "Hi! I just found out about you through a friend."

**Elena** (with goal in system prompt):
> "Â¡Hola! That's so sweet that your friend mentioned me! I'm Elenaâ€”what's your name? I'd love to know who I'm chatting with! ðŸŒŠ"

**Why it works**: Elena asks for the name naturally as part of introducing herself, not as a demand.

### Example 2: Goal Without Forcing

**Active Goal**: `discuss_ocean`

**User**: "I'm having a rough day at work."

**Elena** (respecting user's emotional state):
> "Ay, cariÃ±o, I'm sorry to hear that. Work stress is the worst. Want to talk about it? Sometimes just venting helps."

**Why it works**: Elena prioritizes emotional support over pursuing the ocean goal. The goal doesn't override empathy.

### Example 3: Natural Goal Pursuit

**Active Goal**: `discuss_ocean`

**User**: "I'm thinking about going to the beach this weekend."

**Elena** (finds natural opening):
> "Oh, that sounds amazing! Which beach are you thinking about? I have some favorites around hereâ€”and if you go during low tide at La Jolla, you might spot some incredible tide pool creatures! ðŸ¦€"

**Why it works**: The user mentioned the beach, so Elena naturally steers toward marine topics.

---

## Goal Categories

Goals can be organized into categories:

| Category | Purpose | Examples |
|----------|---------|----------|
| **personal_knowledge** | Learn about the user | `learn_name`, `understand_interests` |
| **expertise** | Share character knowledge | `discuss_ocean`, `share_expertise` |
| **relationship** | Build connection | `build_rapport`, `emotional_support` |

Categories help characters balance their goals across different relationship aspects.

---

## Goal Completion Detection

### GoalAnalyzer Prompt

The analyzer uses an LLM to evaluate conversations:

```python
ACTIVE GOALS:
- Slug: learn_name
  Description: Learn the user's name
  Criteria: User explicitly states their name

- Slug: discuss_ocean
  Description: Have a meaningful conversation about marine life
  Criteria: Conversation contains at least 3 exchanges about ocean/marine topics

RECENT CONVERSATION:
User: "Hi! I'm Alex."
Elena: "Nice to meet you, Alex! I'm Elena, a marine biologist."
User: "That's cool! I've always been fascinated by the ocean."
Elena: "Â¡IncreÃ­ble! The ocean is endlessly fascinating. What draws you to it?"
User: "I love watching documentaries about marine life."
Elena: "Have you seen the one about coral reef ecosystems? It's amazing how interconnected everything is!"

â†’ Returns:
{
  "updates": [
    {
      "slug": "learn_name",
      "status": "completed",
      "progress_score": 1.0,
      "reasoning": "User explicitly said 'I'm Alex'",
      "extracted_data": {"name": "Alex"}
    },
    {
      "slug": "discuss_ocean",
      "status": "in_progress",
      "progress_score": 0.6,
      "reasoning": "2 ocean-related exchanges so far, need 3 for completion"
    }
  ]
}
```

### Extracted Data

When goals are completed, relevant data can be extracted:

- `learn_name` â†’ `{"name": "Alex"}`
- `understand_interests` â†’ `{"interests": ["marine documentaries", "beach walks"]}`

This data can be stored and used elsewhere (e.g., in the Knowledge Graph).

---

## Only Top Goal Is Shown

**Important**: Only the **highest priority** active goal is injected into the system prompt:

```python
if active_goals:
    top_goal = active_goals[0]  # Highest priority only
    goal_context = f"\n\n[CURRENT GOAL: {top_goal['slug']}]\n"
```

### Why?

1. **Cognitive Load**: Too many goals would confuse the LLM
2. **Focus**: One clear objective per conversation
3. **Natural Behavior**: Real people don't juggle 5 goals at once
4. **Priority System**: Most important goals get attention first

Once the top goal is completed, the next highest priority becomes active.

---

## Goal Priority Ordering

Goals are retrieved ordered by priority (descending):

```sql
SELECT g.id, g.slug, g.description, g.success_criteria, g.priority, ...
FROM v2_goals g
LEFT JOIN v2_user_goal_progress p ON g.id = p.goal_id AND p.user_id = $1
WHERE g.character_name = $2
AND (p.status IS NULL OR p.status != 'completed')
ORDER BY g.priority DESC  -- â† Highest priority first
```

**Example priorities**:
- `learn_name`: 10 (highest)
- `share_expertise`: 9
- `discuss_ocean`: 8
- `build_rapport`: 7
- `understand_interests`: 6

---

## Performance Considerations

### PostgreSQL Queries
- `ensure_goals_exist()`: ~20-50ms (checks and inserts if needed)
- `get_active_goals()`: ~10-30ms (JOIN with COALESCE for progress)
- `update_goal_progress()`: ~10-20ms (UPSERT)

### LLM Cost
- GoalAnalyzer uses LLM to evaluate conversations
- Only runs after conversation exchanges (not every message)
- Consider: Run goal analysis asynchronously/background

### Caching
- Character goals are cached in `_character_goals_cache`
- Goal configs loaded once per character per session

---

## Feature Flag

Goal injection can be controlled via settings:

```python
# In settings.py
ENABLE_GOAL_SYSTEM = True  # Default
```

If disabled, no `[CURRENT GOAL]` section is added to the system prompt.

---

## Testing Goals

```python
async def test_get_active_goals():
    """Test that active goals are retrieved correctly."""
    goals = await goal_manager.get_active_goals("test_user", "elena")
    
    # Should have multiple goals for new user
    assert len(goals) > 0
    
    # Should be ordered by priority
    priorities = [g['priority'] for g in goals]
    assert priorities == sorted(priorities, reverse=True)
    
    # learn_name should be first (priority 10)
    assert goals[0]['slug'] == "learn_name"

async def test_goal_completion():
    """Test that completed goals are excluded."""
    # Complete learn_name
    await goal_manager.update_goal_progress(
        "test_user", "learn_name", "elena",
        status="completed", progress=1.0,
        metadata={"extracted": {"name": "Alex"}}
    )
    
    # Get active goals again
    goals = await goal_manager.get_active_goals("test_user", "elena")
    
    # learn_name should not be in list
    slugs = [g['slug'] for g in goals]
    assert "learn_name" not in slugs

async def test_goal_analyzer():
    """Test LLM goal analysis."""
    conversation = """
    User: "Hi! I'm Sarah."
    Elena: "Nice to meet you, Sarah!"
    """
    
    await goal_analyzer.check_goals("test_user", "elena", conversation)
    
    # Verify learn_name was completed
    goals = await goal_manager.get_active_goals("test_user", "elena")
    slugs = [g['slug'] for g in goals]
    assert "learn_name" not in slugs
```

---

## Contrast with Other System Injections

| Injection | How It's Used | Instruction Type |
|-----------|---------------|------------------|
| **Evolution/Trust** | Always affects tone | Directive ("You are at Friend level...") |
| **User Preferences** | Always enforced | Directive ("Keep responses short") |
| **Common Ground** | Reference when relevant | Permissive ("Feel free to reference...") |
| **Goals** | Guide conversation direction | **Suggestive** ("Try to naturally steer...") |

Goals are **suggestive**â€”they influence but don't control the conversation.

---

## Summary

The Goals system creates purposeful conversations through:

1. **Per-Character Goals**: Defined in `goals.yaml` with priorities
2. **Per-User Progress**: Tracked in PostgreSQL with status and metadata
3. **Top Goal Injection**: Only highest priority active goal shown
4. **Suggestive Instruction**: "Try to naturally steer... without being pushy"
5. **LLM Analysis**: GoalAnalyzer detects completion and progress
6. **Extracted Data**: Completed goals can capture useful information

The result is a bot with **natural conversational objectives** that guide engagement without feeling robotic or pushy.

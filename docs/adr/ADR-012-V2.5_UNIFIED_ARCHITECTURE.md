# ADR-012: v2.5 Unified Architecture ("Ship of Theseus")

**Status:** Accepted
**Date:** December 11, 2025
**Author:** Mark Castillo & Claude
**Context:** WhisperEngine v2.0

## Context
WhisperEngine v2.0 is a **Reactive System**. It relies on a "stimulus-response" loop:
1.  User sends message (Stimulus).
2.  System retrieves context (Vector Search).
3.  System generates response (LLM).
4.  System sleeps.

While effective for chat, this architecture limits "aliveness." The bot has no inner life, no continuity between sessions unless explicitly retrieved, and no ability to reorganize its own memory.

We want to evolve towards a **Predictive Processing System** where the agent is "always on," consolidating memory during idle time ("Dreaming"), and reacting to the environment in real-time ("Streaming").

However, a full rewrite (v3) is costly and risky. The v2 codebase is stable and feature-rich.

## Decision
We will adopt a **"Ship of Theseus" Evolution Strategy** (v2.5). We will upgrade the core cognitive components in place without rewriting the entire application shell.

The core architectural shift is from **Dual-Store Memory** (Vector OR Graph) to **Unified Memory** (Vector AND Graph).

### Key Architectural Changes:

1.  **Unified Memory (Graph Unification):**
    *   **Old:** `MemoryManager` (Qdrant) and `KnowledgeManager` (Neo4j) were separate.
    *   **New:** Every Vector Memory has a corresponding Graph Node. Retrieval starts with Vector Search (Semantic) and expands via Graph Traversal (Structural).
    *   **Why:** Solves the context window problem by retrieving *structure*, not just text.
    *   **The Associative Model:** Retrieving 3-5 semantically relevant memories (vector search) automatically expands to their graph neighborhoods (relationships, co-occurring memories, linked entities), giving you a "whole context view" from those entry points. Each memory acts as a window into the larger memory network â€” not as isolated facts, but as traversable structure. This is "associative" because **any memory you retrieve contains implicit access to the broader context** through its graph relationships.

2.  **The Dream (Active Idle):**
    *   **Old:** Idle time = Sleep.
    *   **New:** Idle time = Optimization. A background `DreamGraph` traverses the memory graph to consolidate, prune, and synthesize new connections.
    *   **Why:** Mimics biological consolidation; creates emergent "epiphanies."

3.  **The Stream (Event-Driven):**
    *   **Old:** Polling loop (7 mins).
    *   **New:** Hybrid Polling + Event Push. High-signal events trigger immediate processing.
    *   **Why:** "Aliveness" requires responsiveness, not just periodic checking.

4.  **The Soul (Dynamic Identity):**
    *   **Old:** Static `character.md` and `core.yaml`.
    *   **New:** Self-editing `core.yaml` (via PRs proposed by the Dreamer), constrained by an immutable `Constitution`.
    *   **Why:** Allows for true character arcs and personality evolution.

## Consequences

### Positive
*   **Emergence:** The system can surprise us (new connections, personality shifts).
*   **Continuity:** "Unified" retrieval provides much richer context than flat vector search.
*   **Efficiency:** "Dreaming" moves expensive reasoning to off-peak hours.
*   **Stability:** Incremental upgrades reduce the risk of a "big bang" rewrite failure.

### Negative
*   **Complexity:** The interaction between Vector and Graph is harder to debug.
*   **Cost:** Background "Dreaming" consumes tokens even when no users are present.
*   **Observability:** It becomes harder to trace *why* the bot said something (was it a retrieved memory? A dream? A graph traversal?).

## Compliance
*   **Emergence Philosophy (ADR-003):** We build the *mechanism* (Dreaming), not the *content*.
*   **Safety:** The "Constitution" ensures that self-editing does not violate safety guidelines.

## References
*   `docs/roadmaps/ROADMAP_V2.5_EVOLUTION.md`
*   `docs/spec/SPEC-E34-THE_DREAM_ACTIVE_IDLE.md`
